<div class="offcanvas-header">
  <h5 class="offcanvas-title">
    {% if form.instance.pk %}Editar Pel√≠cula{% else %}Nueva Pel√≠cula{% endif %}
  </h5>
{#  <button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas"></button>#}
</div>

<div class="offcanvas-body">
  <form method="post"
        action="{{ request.path }}"
        enctype="multipart/form-data"
        hx-post="{{ request.path }}"
        hx-target="#offcanvasBody"
        hx-swap="innerHTML"
        hx-sync="this:drop"
{#        hx-on="htmx:afterRequest:#}
{#                 if (event.detail.xhr.status !== 422) {#}
{#                   htmx.trigger(htmx.find('#tbodyPelis'),'refresh');#}
{#                   bootstrap.Offcanvas.getOrCreateInstance('#peliculaOffcanvas').hide();#}
{#                 }">#}
          hx-on="htmx:afterRequest:
                   if (event.target === this && event.detail.xhr.status !== 422) {
                     htmx.trigger(htmx.find('#tbodyPelis'), 'refresh');
                     bootstrap.Offcanvas.getOrCreateInstance('#peliculaOffcanvas').hide();
                   }">
    {% csrf_token %}

    <!-- Campos de Pelicula -->
    {{ form.as_p }}

    <hr class="my-3">

    <!-- Inline formset: Actores -->
    <h6 class="mb-2">Actores</h6>

    {{ actores.management_form }}

<div class="table-responsive">
  <table class="table table-dark table-sm align-middle mb-2" id="actorFormsetTable">
    <thead>
      <tr>
        <th>Actor</th>
        <th class="text-center">Borrar</th>
      </tr>
    </thead>
    <tbody id="actorFormsetBody">
      {% for f in actores.forms %}
        {% include "_actorFormRow.html" with f=f %}
      {% empty %}
        <tr id="sinActoresRow">
          <td colspan="3" class="text-muted">Sin actores a√∫n.</td>
        </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<div class="d-flex justify-content-between align-items-center">

{% if form.instance.pk %}
    {# EDITAR: endpoint con pk #}
    <button type="button" class="btn btn-outline-light btn-sm"
            hx-post="{% url 'peliculaactoraddform' form.instance.pk %}"
            hx-include="closest form"
            hx-target="#actorFormsetBody"
            hx-swap="beforeend">
      + Agregar actor
    </button>
{% else %}
    {# CREAR: endpoint sin pk #}
    <button type="button" class="btn btn-outline-light btn-sm"
            hx-post="{% url 'peliculaactoraddformnew' %}"
            hx-include="closest form"
            hx-target="#actorFormsetBody"
            hx-swap="beforeend">
      + Agregar actor
    </button>
{% endif %}

{#  <button type="button"#}
{#          class="btn btn-outline-light"#}
{#          hx-post="{% url 'peliculaactoraddform' form.instance.pk %}"#}
{#          hx-include="closest form"#}
{#          hx-target="#actorFormsetBody"#}
{#          hx-swap="beforeend">#}
{#    + Agregar actor#}
{#  </button>#}

      <div class="d-flex gap-2">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="offcanvas">Cancelar</button>
        <button type="submit" class="btn btn-primary">Guardar</button>
      </div>
    </div>
  </form>
</div>

{#<div class="offcanvas-header">#}
{#  <h5 class="offcanvas-title tituloficha">#}
{#    {% if form.instance.pk %}Editar Pel√≠cula{% else %}Nueva Pel√≠cula{% endif %}#}
{#  </h5>#}
{#  <button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas"></button>#}
{#</div>#}
{##}
{#<div class="offcanvas-body">#}
{#  <form method="post"#}
{#        action="{{ request.path }}"#}
{#        enctype="multipart/form-data"#}
{#        hx-post="{{ request.path }}"#}
{#        hx-target="#offcanvasBody"#}
{#        hx-swap="innerHTML"#}
{#        hx-on="htmx:afterRequest:#}
{#               if (event.detail.xhr.status !== 422) {#}
{#                 htmx.trigger(htmx.find('#tbodyPelis'), 'refresh');  /* üëà clave */#}
{#                 bootstrap.Offcanvas.getOrCreateInstance('#peliculaOffcanvas').hide();#}
{#               }">#}
{#    {% csrf_token %}#}
{#    {{ form.as_p }}#}
{##}
{#        <h3 class="titulo">Actores</h3>#}
{#        {{ actores.management_form }}#}
{#        <table class="table table-striped">#}
{#            {% for form in actores %}#}
{#                <tr>#}
{#                    <td style="display:none;">{{ form.id }}</td>#}
{#                    <td>{{ form.idActor }}</td>#}
{#                    <td>{{ form.DELETE }}</td>#}
{#                </tr>#}
{#            {% endfor %}#}
{#        </table>#}
{##}
{#        <button type="submit" class="btn btn-primary">Guardar</button>#}
{#        <a class="btn btn-primary" href="{% url 'peliculaslistaoc' %}">Cancelar</a>#}
{#    </form>#}
{#</div>#}